<!-- Search and Filter Controls -->
<div class="filter-controls-container">
  <div class="filter-controls">
    <div class="search-wrapper">
      <div class="input-wrapper">
        <i class="material-symbols-outlined search-icon">search</i>
        <input
          type="text"
          [(ngModel)]="searchQuery"
          placeholder="{{ 'device-manager.search.placeholder' | translate }}"
        />
      </div>
    </div>

    <div class="tag-filter" *ngIf="tags.length > 0">
      <app-select-box
        type="SMALL"
        class="tag-filter-select"
        [items]="tagFilterOptions"
        [selected]="selectedTagFilterOption"
        (selectedChange)="onTagFilterChange($event)"
      ></app-select-box>
    </div>
  </div>
</div>

<!-- Device List -->
<div class="device-list">
  <div
    class="device-group"
    *ngFor="let group of deviceGroups; trackBy: trackDeviceGroupBy"
    @vshrink
  >
    <div class="device-group-header">
      <img
        *ngIf="group.type !== 'PREVIOUSLY_SEEN'"
        [src]="'/assets/img/icon_' + group.icon + '.png'"
        class="category-icon"
      />
      <i
        *ngIf="group.type === 'PREVIOUSLY_SEEN'"
        class="material-icons category-icon-text"
        style="color: var(--color-text-3); font-size: 1.5em; margin-right: 0.75em"
      >
        history
      </i>
      <span class="group-label" translate>{{ group.label }}</span>
      <span class="group-count">({{ group.devices.length }})</span>
    </div>

    <div
      class="device-item"
      *ngFor="let device of group.devices; trackBy: trackDeviceBy"
      [class.has-nickname]="!!device.nickname"
      [class.has-tags]="getDeviceTags(device).length > 0"
      @vshrink
    >
      <!-- Tag-based left border -->
      <div class="tag-border" *ngIf="getDeviceTags(device).length > 0">
        <div
          class="tag-border-segment"
          *ngFor="let tag of getDeviceTags(device); trackBy: trackTagBy"
          [style.background-color]="tag.color"
        ></div>
      </div>

      <!-- Device Header -->
      <div class="device-header" (click)="configureDevice(device)">
        <!-- Main Row with core device info -->
        <div class="device-main-row">
          <img
            [src]="'/assets/img/icon_' + getDeviceTypeIconForDevice(device.deviceType) + '.png'"
            class="device-icon"
          />

          <div class="device-info">
            <div class="device-name-line">
              <span class="device-name">{{ device.typeName }}</span>
              <i
                class="material-icons hidden-icon"
                *ngIf="device.disabled"
                [tooltip]="'device-manager.config.disabled.tooltip' | translate"
                [tooltipMode]="'right'"
              >
                visibility_off
              </i>
              <span class="device-serial" *ngIf="getDeviceSerialNumber(device) && device.nickname">
                S/N: {{ getDeviceSerialNumber(device) }}
              </span>
            </div>
            <div class="device-details">
              <!-- Show nickname if set, otherwise show default name -->
              <span class="device-default-name">
                {{ device.nickname || device.defaultName }}
              </span>
              <!-- Show role if available -->
              <span class="device-role" *ngIf="getDeviceRole(device)" translate>
                {{ getDeviceRole(device) }}
              </span>
            </div>
          </div>

          <!-- Battery Info -->
          <div class="battery-info" *ngIf="getDeviceBatteryInfo(device) as battery">
            <span class="battery-level">{{ battery.level }}%</span>
            <i class="material-icons battery-icon" [class.charging]="battery.isCharging">
              {{ battery.isCharging ? 'battery_charging_full' : 'battery_std' }}
            </i>
          </div>

          <!-- Action Buttons -->
          <div class="device-actions" (click)="$event.stopPropagation()">
            <!-- Power Button -->
            <app-device-power-button
              *ngIf="canShowPowerButton(device)"
              [id]="'btn-power-dm-' + sanitizeIdForCSS(device.id)"
              [powerState]="getDevicePowerState(device)"
              [anchorName]="getPowerButtonAnchorId(device)"
              [allowUnknownClick]="!!getDeviceLighthouse(device)"
              (powerAction)="handleDevicePowerAction(device, $event)"
              (rightClick)="rightClickDevicePowerButton(device)"
            ></app-device-power-button>

            <!-- Lighthouse Force State Popover -->
            <div
              *ngIf="showLHStatePopover && selectedPopoverDevice?.id === device.id"
              (clickOutside)="onClickOutsideLHStatePopover($event)"
              @fade
              class="lh-popover-container"
            >
              <app-lighthouse-force-state-popover
                (action)="onForceLHState(device, $event)"
                [style.position-anchor]="getPowerButtonAnchorId(device)"
                [type]="getDeviceLighthouse(device)?.deviceType"
              >
              </app-lighthouse-force-state-popover>
            </div>

            <!-- Forget Button -->
            <button
              class="btn-forget"
              *ngIf="!isDeviceObserved(device.id)"
              (click)="forgetDevice(device)"
              [tooltip]="'device-manager.actions.forget' | translate"
              [tooltipMode]="'left'"
            >
              <i class="material-icons">delete</i>
            </button>
          </div>
        </div>

        <!-- Tags Row (separate row for better responsiveness) -->
        <div class="device-tags-row" *ngIf="getDeviceTags(device).length > 0">
          <div class="device-tags-responsive">
            <div
              class="tag-chip"
              *ngFor="let tag of getDeviceTags(device); trackBy: trackTagBy"
              [tooltip]="tag.name"
              [tooltipMode]="'left'"
            >
              <div class="tag-color" [style.background-color]="tag.color"></div>
              <span class="tag-name">{{ tag.name }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="deviceGroups.length === 0" @vshrink>
    <i class="material-icons">info</i>
    <span translate>{{ emptyStateMessage }}</span>
  </div>
</div>
